---
title: "Perceelsgroottes landbouwgebieden in Vlaanderen"
author: "Ward Langeraert"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# Set up
library(knitr)
library(here)
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE)
opts_knit$set(root.dir = here())

# Packages
library(tidyverse)
library(INBOtheme)
library(sf)
library(mapview)

conflicted::conflicts_prefer(dplyr::filter)
conflicted::conflicts_prefer(dplyr::select)
conflicted::conflicts_prefer(dplyr::lag)

# Source
source(here("source", "scripts", "calc_parcel_size.R"))
```

# Vraag

We willen een idee van de decielen, mediaan, gemiddelde ... van de 'feitelijk' perceelsgrootte voor akkers (incl. tijdelijk gras) in Vlaanderen en binnen de soortbeschermingsgebieden.
Met 'feitelijke' percelen bedoelen we dat aangrenzende percelen met hetzelfde gewas als één perceel tellen.

# Kaartlagen

```{r}
years <- 2018:2023
```

Kaartlagen van landbouwgebruikspercelen zijn gedownload via [landbouwcijfers.vlaanderen.be](https://landbouwcijfers.vlaanderen.be/open-geodata-landbouwgebruikspercelen).
We zullen berekeningen doen o.b.v. de kaarten van `r min(years)` t/m `r max(years)`.
De kaart van 2023 is nog niet finaal is kan dus nog fouten kan bevatten (extractie 04-12-2023).


```{r}
# Load parcel files
layer_list <- vector("list", length = length(years))

for (i in seq_along(years)) {
  # create path variable
  year <- years[i]
  path <- paste("Landbouwgebruikspercelen", year, sep = "_")

  # read layer
  layer_sf <- st_read(
           file.path(
             "data", "landbouwgebruikspercelen", path, paste0(path, ".shp"))
             )
  if (is.na(st_crs(layer_sf))) {
    layer_sf <- layer_sf %>%
      st_set_crs(31370)
  } else {
    layer_sf <- layer_sf %>%
      st_transform(crs = 31370)
  }

  layer_list[[i]] <- layer_sf %>%
    mutate(jaar = year)
}
names(layer_list) <- years
```

Onderstaand voorbeeld toont hoe we van percelen naar 'feitelijke' percelen gaan.
We selecteren een detail van de kaart van 2022.

```{r}
detail <- c("xmin" = 200000,
            "ymin" = 173000,
            "xmax" = 202000,
            "ymax" = 175000)

detail_sf <- tibble(geometry = st_as_sfc(st_bbox(detail))) %>%
  st_as_sf() %>%
  st_set_crs(31370)

print(detail)
```

De originele kaart ziet er uit als volgt:

```{r}
test_layer <- st_crop(layer_list[["2022"]], detail_sf) %>%
  select(REF_ID, GWSNAM_H, GWSGRPH_LB)

# Visualise
mapview(test_layer, zcol = "GWSNAM_H", legend = FALSE)
```

We groeperen aangrenzende percelen met dezelfde hoofdteelt:

```{r}
# Join neighbouring polygons by main crop
test_layer_grouped <- test_layer %>%
  filter(!is.na(GWSNAM_H)) %>%
  group_by(GWSNAM_H, GWSGRPH_LB) %>%
  summarise() %>%
  st_cast("MULTIPOLYGON") %>%
  st_cast("POLYGON") %>%
  ungroup()

# Visualise
mapview(test_layer_grouped, zcol = "GWSNAM_H", legend = FALSE)
```


# Berekening perceelsgroottes en statistieken
## Vlaanderen

```{r}
# Create cache directory
cache_path <- "source/markdown/perceelsgroottes_vlaanderen_cache"
dir.create(cache_path, showWarnings = FALSE)

# Read or save grouped parcels object
file <- file.path(cache_path, "parcels_grouped_list.rds")
if (file.exists(file)) {
  parcels_grouped_list <- readRDS(file)
} else {
  parcels_grouped_list <- lapply(layer_list, function(sf) {
    year <- unique(sf$jaar)

    print(paste("Start samenvoegen percelen", year))
    out <- calc_parcel_size(sf) %>%
      mutate(jaar = year)
    print(paste("Einde samenvoegen percelen", year))

    return(out)
    })

  saveRDS(parcels_grouped_list, file)
}

# List to one single dataframe
parcels_grouped_list_nosf <- lapply(parcels_grouped_list, st_drop_geometry)
parcels_grouped_df <- do.call(rbind.data.frame, parcels_grouped_list_nosf)
```

De kaartlagen bevatten meerdere gewassen die in groepen zijn opgedeeld.
Ter exploratie bekijken we de verdeling van de medianen van de oppervlaktes per gewasgroep per jaar (in ha).

```{r}
parcels_grouped_df %>%
  group_by(GWSGRPH_LB, jaar) %>%
  summarise(area_ha = median(area_ha)) %>%
  ungroup() %>%
  mutate(GWSGRPH_LB = reorder(GWSGRPH_LB, area_ha)) %>%
  ggplot(aes(x = GWSGRPH_LB, y = area_ha)) +
    geom_boxplot() +
    labs(x = "",
         y = paste0("mediaan oppervlakte\n'feitelijke' percelen ",
                    min(years), "-", max(years), " (ha)")) +
    scale_y_continuous(limits = c(0, NA)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

We zien dat landbouwinfrastructuur en water elk jaar een lage gemiddelde perceelsgrootte hebben.
Dit terwijl we wel zien dat er heel veel percelen onder de categorie "Landbouwinfrastructuur" vallen.
Deze zal dus een grote invloed hebben op de uiteindelijke verdeling van de perceelsgroottes, terwijl we niet geïnteresseerd zijn in landbouwinfrastructuur.
We zullen landbouwinfrastructuur verwijderen uit de dataset en water ook aangezien deze ook niet relevant is voor ons.

```{r}
parcels_grouped_df %>%
  count(GWSGRPH_LB, jaar) %>%
  group_by(jaar) %>%
  mutate(som_jaar = sum(n)) %>%
  ungroup() %>%
  mutate(prop = n / som_jaar) %>%
  group_by(GWSGRPH_LB) %>%
  mutate(mean_prop = mean(prop)) %>%
  ungroup() %>%
  mutate(GWSGRPH_LB = reorder(GWSGRPH_LB, mean_prop)) %>%
  ggplot(aes(x = GWSGRPH_LB, y = prop)) +
    geom_boxplot() +
    labs(x = "",
         y = paste0("proportie aantal percelen\n",
                   min(years), "-", max(years))) +
    scale_y_continuous(limits = c(0, NA)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r}
parcels_grouped_final <- parcels_grouped_df %>%
  filter(!GWSGRPH_LB %in% c("Landbouwinfrastructuur", "Water"))
```

Samenvattende statistieken voor de 'feitelijke' perceelsgroottes per jaar in Vlaanderen:

```{r}
parcels_grouped_summary <- parcels_grouped_final %>%
  group_by(jaar) %>%
  summarise(
    min = min(area_ha),
    Q10 = quantile(area_ha, 0.1),
    Q20 = quantile(area_ha, 0.2),
    Q30 = quantile(area_ha, 0.3),
    Q40 = quantile(area_ha, 0.4),
    Q50 = quantile(area_ha, 0.5),
    Q60 = quantile(area_ha, 0.6),
    Q70 = quantile(area_ha, 0.7),
    Q80 = quantile(area_ha, 0.8),
    Q90 = quantile(area_ha, 0.9),
    max = max(area_ha),
    gemiddelde = mean(area_ha),
    st_dev = sd(area_ha)
  )

parcels_grouped_summary %>%
  kable(digits = 3)
```

```{r}
parcels_grouped_final %>%
  group_by(jaar) %>%
  summarise(
    Q25 = quantile(area_ha, 0.25),
    mediaan = quantile(area_ha, 0.5),
    Q75 = quantile(area_ha, 0.75),
    gemiddelde = mean(area_ha)) %>%
  ungroup() %>%
  pivot_longer(-jaar, names_to = "statistiek", values_to = "waarde") %>%
  mutate(statistiek = factor(
    statistiek,
    levels = c("Q25", "mediaan", "gemiddelde", "Q75")
    )) %>%
  ggplot(aes(x = jaar, y  = waarde, colour = statistiek)) +
    geom_point() +
    geom_line() +
    labs(x = "",
         y = "perceelsgrootte (ha)") +
    scale_y_continuous(limits = c(0, NA))
```

## Soortbeschermingsgebieden

